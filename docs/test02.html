<!DOCTYPE html>
<html lang="ja">
	<head>
		<meta charset="utf-8">
		<title>Three.js Practice</title>

		<script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
		<script src="js/three.min.js"></script>
		<script src="js/renderers/Projector.js"></script>
		<script src="js/renderers/CanvasRenderer.js"></script>
		<script src="js/libs/stats.min.js"></script>
	</head>
	<body>



		<script>
			/**
 * Particles.js
 */

			var container;

			//PCD
			//			var dataPath = 'data/test.pcd';
			var dataPath = 'data/PointCroudData.pcd';

			var depthData=[];

			function ready(){

				// DOM
				container = document.createElement('div');
				document.body.appendChild(container);

				// Scene
				var scene = new THREE.Scene();

				// Camera
				var width=640*1.2;
				var height=480*1.2;

				//カメラを初期化
				var camera = new THREE.PerspectiveCamera(45, width/height, 10, 150000);
				camera.position.set(width/2, height/2, (height/2)/Math.tan(Math.PI/8));
				camera.lookAt(new THREE.Vector3(width/2,height/2,0));

				//add box
				geometry = new THREE.CubeGeometry(200, 200, 200);
				material = new THREE.MeshBasicMaterial({
					color: 0xff0000,
					wireframe: true
				});

				mesh = new THREE.Mesh(geometry, material);
				scene.add(mesh);

				// Objects
				var circleTexture   = new THREE.TextureLoader().load('https://dl.dropboxusercontent.com/u/873331/Projects/threejs/circle.png');
				var triangleTexture = new THREE.TextureLoader().load('https://dl.dropboxusercontent.com/u/873331/Projects/threejs/triangle.png');
				var parameters = {
					square: { size: 10, color:0x00ffff, blending: THREE.NoBlending },
					circle: { size: 10, color:0xf5f5f5, map: circleTexture, blending: THREE.NormalBlending, transparent: true, alphaTest: 0.9 },
					triangle: { size: 10, color:0xffff00, map: triangleTexture, blending: THREE.NormalBlending, transparent: true, alphaTest: 0.9 }
				};

				var squaresGeometry = createDepthGeometry();
				//				var squaresGeometry = createGeometry(1800);
				var squaresMaterial = new THREE.PointsMaterial(parameters.square);
				var squares         = new THREE.Points(squaresGeometry, squaresMaterial);

				var trianglesGeometry = createGeometry(1000);
				var trianglesMaterial = new THREE.PointsMaterial(parameters.triangle);
				var triangles         = new THREE.Points(trianglesGeometry, trianglesMaterial);

				var circlesGeometry = createGeometry(1300);
				var circlesMaterial = new THREE.PointsMaterial(parameters.circle);
				var circles         = new THREE.Points(circlesGeometry, circlesMaterial);


				//				scene.add(squares, circles, triangles);
				scene.add(squares);

				drawAxis();

				// Renderer
				var renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
				renderer.setSize(width, height);
				renderer.setClearColor(0xffffff, 0);
				renderer.setPixelRatio(window.devicePixelRatio);
				container.appendChild(renderer.domElement);

				animate();

				function animate() {
					requestAnimationFrame(animate);
					render();
				}

				function render() {
					squares.rotation.x += .001;
					squares.rotation.y += .0003;
					squares.rotation.z += .0001;

					circles.rotation.x += .001;
					circles.rotation.y += .0003;
					circles.rotation.z += .0001;

					triangles.rotation.x -= .0001;
					triangles.rotation.y -= .0002;
					triangles.rotation.z -= .001;

					renderer.render(scene, camera);
				}

				function createGeometry(count) {
					var geometry = new THREE.Geometry();

					for (var i = 0; i < count; i++) {
						var x = Math.random() * 1000 - 500;
						var y = Math.random() * 1000 - 500;
						var z = Math.random() * 1000 - 500;
						var particle = new THREE.Vector3(x, y, z);
						particle.velocity = new THREE.Vector3(0, -Math.random(), 0);
						geometry.vertices.push(particle);
					}

					return geometry;
				}

				function createDepthGeometry() {
					var geometry = new THREE.Geometry();

					console.log(depthData.length);


					for(var value of depthData) {
						var x = Math.random() * 1000 - 500;
//						console.log(value,x);
						var particle = new THREE.Vector3(value[0],value[1],value[2]);
						particle.velocity = new THREE.Vector3(0, -Math.random(), 0);
						geometry.vertices.push(particle);
					}

					//					for (var i = 0; i < depthData.length; i++) {
					//						var x = Math.random() * 1000 - 500;
					//						var y = Math.random() * 1000 - 500;
					//						var z = Math.random() * 1000 - 500;
					//						var particle = new THREE.Vector3(x, y, z);
					//						particle.velocity = new THREE.Vector3(0, -Math.random(), 0);
					//						geometry.vertices.push(particle);
					//					}

					return geometry;
				}


				//座標系
				function drawAxis(){
					// line
					//create a blue LineBasicMaterial
					var material = new THREE.LineBasicMaterial({ color: 0x0000ff });

					var geometry = new THREE.Geometry();

					var lineLenght = 10000;
					geometry.vertices.push(new THREE.Vector3(0, 0, 0));
					geometry.vertices.push(new THREE.Vector3(lineLenght, 0, 0));
					geometry.vertices.push(new THREE.Vector3(0, 0, 0));
					geometry.vertices.push(new THREE.Vector3(0, lineLenght, 0));
					geometry.vertices.push(new THREE.Vector3(0, 0, 0));
					geometry.vertices.push(new THREE.Vector3(0, 0, lineLenght));

					var line = new THREE.Line(geometry, material);

					scene.add(line);
				}
			};

			//PCDの読み込み
			function init(){
				$.ajax({
					url:dataPath,
					success: function(data){
						var data = data.split(/\r\n|\r|\n/);// 行ごとに分割
						//PCDは10行目から
						for(var i=10;i<data.length;i++){
							var row = [];
							for(var x of data[i].split(' ')){
								//string型からfloat型にキャストして値を追加
								row.push(parseFloat(x));
							}
							depthData.push(row);//数値に直した結果をデプスデータに追加
						}
					}
				}).done(function(){
					ready();
				});
			}
			window.addEventListener('load', init, false);


		</script>

	</body>
</html>